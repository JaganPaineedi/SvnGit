/****** Object:  StoredProcedure [dbo].[Csp_CreateImageRecordsForEmbeddedPDF]    Script Date: 06/25/2015 16:04:30 ******/
IF EXISTS (
		SELECT *
		FROM sys.objects
		WHERE object_id = OBJECT_ID(N'[dbo].[Csp_CreateImageRecordsForEmbeddedPDF]')
			AND type IN (
				N'P'
				,N'PC'
				)
		)
	DROP PROCEDURE [dbo].[Csp_CreateImageRecordsForEmbeddedPDF]
GO

/****** Object:  StoredProcedure [dbo].[Csp_CreateImageRecordsForEmbeddedPDF]    Script Date: 06/25/2015 16:04:30 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Csp_CreateImageRecordsForEmbeddedPDF] @ClientOrderId INT
	,@ClientId INT
	,@InboundMessage XML
	,@HL7CPQueueMessageID INT
AS
--=======================================
/* 
Description : Used to update the Lab order Observation to Flowsheet      

-- Aug 12 2015		ShankhaB    Process the embedded PDF from the message as ImageRecord and ImageRecordItem for the CLient Order as part of Inbound 
--								Result processing
*/
--=======================================
BEGIN
	DECLARE @TranName VARCHAR(20) = 'CreateImageRecordsForEmbeddedPDF]'
	DECLARE @Error VARCHAR(8000)

	BEGIN TRY
		BEGIN
			DECLARE @DocumentVersionId AS INT = 0
			DECLARE @ImageServerId AS INT = 0
			DECLARE @ImageRecordId AS INT = 0

			SELECT @DocumentVersionId = DocumentVersionId
			FROM ClientOrders
			WHERE ClientOrderId = @ClientOrderId

			SELECT @ImageServerId = ImageServerId
			FROM ImageServers IMG
			WHERE ISNULL(IMG.RecordDeleted, 'N') = 'N'

			IF (
					@DocumentVersionId > 0
					AND @ImageServerId > 0
					)
			BEGIN
				BEGIN TRANSACTION @TranName

				INSERT INTO ImageRecords (
					CreatedDate
					,ModifiedDate
					,ScannedOrUploaded
					,DocumentVersionId
					,ImageServerId
					,ClientId
					,AssociatedId
					,AssociatedWith
					,RecordDescription
					,EffectiveDate
					,NumberOfItems
					)
				VALUES (
					 getDate()
					,getDate()
					,'U'
					,@DocumentVersionId
					,@ImageServerId
					,@ClientId
					,1625
					,5828-- Lab Results As Structured Data
					,-- Client Orders
					'Lab Report'
					,getDate()
					,1
					)

				SET @ImageRecordId = SCOPE_IDENTITY()
				
				IF (@ImageRecordId > 0)
				BEGIN
					declare @embededPDFString varchar(max);
					--set @embededPDFString= 'JVBERi0xLjINCiX5+prnDQo3IDAgb2JqDQo8PAovRSA2ODkxCi9IIFsxMjAyIDE1Ml0KL0wgMTAzOTQKL0xpbmVhcml6ZWQgMQovTiAyCi9PIDEwCi9UIDEwMjA2Cj4+ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICANCmVuZG9iag0KDQp4cmVmDQo3IDkNCjAwMDAwMDAwMTcgMDAwMDAgbg0KMDAwMDAwMTExMyAwMDAwMCBuDQowMDAwMDAxMjAyIDAwMDAwIG4NCjAwMDAwMDEzNTQgMDAwMDAgbg0KMDAwMDAwMTY1NSAwMDAwMCBuDQowMDAwMDAxNzU2IDAwMDAwIG4NCjAwMDAwMDE4NjEgMDAwMDAgbg0KMDAwMDAwMTk2NyAwMDAwMCBuDQowMDAwMDAzOTk0IDAwMDAwIG4NCnRyYWlsZXINCjw8Ci9BQkNwZGYgOTEwMgovSUQgWzw1Q0JDMUZBMjQwMzE0MDlENjg1MkYzNzg4RkMzNkI4Qj4KPEI0NzlGNzU1NTE4MEJBMzM3MjE1QUZGMTJGQjUyMUZGPl0KL0luZm8gNiAwIFIKL1ByZXYgMTAxOTYKL1Jvb3QgOCAwIFIKL1NpemUgMTYKL1NvdXJjZSAoV2VKWEZ4Tk80ZkpkdXlVTWV0VGNQOStvYU9OZklOTjQrZDYzek9ya1cya0g4VUNlZVg3ZlNZODhCazQ4Z3dkUEI5a2hnbThWdENGbXlkOGdJcndPalFSQUlqUHNXaE00dmdNQ1ZcDQo4S3ZWRi9LOGxmRHQrUWdmcFRrYngyclQzMG9ZWnN0YTRWWStoY25HRWc9KQo+PiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg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5FC/k6/DwXDwXy4X9t4NCmVuZHN0cmVhbQ0KZW5kb2JqDQoNCjMgMCBvYmoNCjw8Ci9UeXBlIC9PdXRsaW5lcwo+Pg0KZW5kb2JqDQoNCjQgMCBvYmoNCjw8Ci9Db3VudCAyCi9LaWRzIFs1IDAgUl0KL1R5cGUgL1BhZ2VzCj4+DQplbmRvYmoNCg0KNSAwIG9iag0KPDwKL0NvdW50IDIKL0tpZHMgWzEwIDAgUiAxIDAgUl0KL1BhcmVudCA0IDAgUgovVHlwZSAvUGFnZXMKPj4NCmVuZG9iag0KDQo2IDAgb2JqDQo8PAovUHJvZHVjZXIgKEF0bGFzIERldmVsb3BtZW50IENvcnAgdmlhIEFCQ3BkZikKPj4NCmVuZG9iag0KDQp4cmVmDQowIDcNCjAwMDAwMDAwMDAgNjU1MzUgZg0KMDAwMDAwNjg5MSAwMDAwMCBuDQowMDAwMDA3MTkwIDAwMDAwIG4NCjAwMDAwMDk5MzcgMDAwMDAgbg0KMDAwMDAwOTk3OSAwMDAwMCBuDQowMDAwMDEwMDQxIDAwMDAwIG4NCjAwMDAwMTAxMjQgMDAwMDAgbg0KdHJhaWxlcg0KPDwKL1NpemUgNwo+Pg0Kc3RhcnR4cmVmDQoxODgNCiUlRU9GDQo=';					
					
					SELECT @embededPDFString = T.item.value('ZEF.2[1]/ZEF.2.0[1]/ITEM[1]','VARCHAR(MAX)')
					FROM @InboundMessage.nodes('HL7Message/ZEF') AS T ( item )	
					
					
					INSERT INTO ImageRecordItems (
					ImageRecordId
					,ItemNumber
					,ItemImage
					,CreatedDate
					,ModifiedDate
					)
				VALUES (
					@ImageRecordId
					,1
					,cast(N'' as xml).value('xs:base64Binary(sql:variable("@embededPDFString"))', 'varbinary(max)')
					,getDate()
					,getDate()
					)
				END
				COMMIT TRANSACTION @TranName
			END
		END
	END TRY

	BEGIN CATCH
		IF EXISTS (
				SELECT 1
				FROM Sys.dm_tran_active_transactions
				WHERE NAME = @TranName
				)
			ROLLBACK TRANSACTION @TranName

		SET @Error = CONVERT(VARCHAR(4000), ERROR_MESSAGE()) + '*****' + ISNULL(CONVERT(VARCHAR, ERROR_PROCEDURE()), 'Csp_CreateImageRecordsForEmbeddedPDF')

		INSERT INTO HL7CPEventLogs (
			HL7CPQueueMessageId
			,ErrorMessage
			,ErrorType
			,CreatedBy
			,CreatedDate
			,ModifiedBy
			,ModifiedDate
			)
		VALUES (
			@HL7CPQueueMessageID
			,@Error
			,'HL7 Procedure Error'
			,'HL7 Connector Platform'
			,GETDATE()
			,'HL7 Connector Platform'
			,GETDATE()
			)

		RAISERROR (
				@Error
				,-- Message text.                                                                      
				16
				,-- Severity.                                                                      
				1 -- State.                                                                      
				);
	END CATCH
END
GO

